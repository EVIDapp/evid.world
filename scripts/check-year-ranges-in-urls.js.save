import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// –ö–æ–ø–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ slugify –∏–∑ utils
const slugify = (text) => {
  let slug = text.toLowerCase().trim();
  slug = slug.replace(/[‚Äì‚Äî‚Äï‚àí]/g, "-");
  slug = slug.replace(/\s*\([^)]*\)/g, "");
  slug = slug.replace(/(\d{4})(\d{4})/g, "$1-$2");
  slug = slug.replace(/-?(?:ongoing|present|current)$/g, "");
  slug = slug.replace(/\b(\d{1,4})\s*(bc|ad)\b/g, "$1-$2");
  slug = slug.replace(/(-\d{1,4})-\1\b/g, "$1");
  slug = slug.replace(/[\s_]+/g, "-");
  slug = slug.replace(/[^a-z0-9-]/g, "");
  slug = slug.replace(/-+/g, "-");
  slug = slug.replace(/^-+|-+$/g, "");
  return slug;
};

const generateEventSlug = (title, year) => {
  const titleSlug = slugify(title);
  
  let y = String(year ?? "").trim();
  
  if (!y) {
    const yearInParentheses = title.match(/\(([^)]+)\)\s*$/);
    if (yearInParentheses) {
      y = yearInParentheses[1].trim();
    }
  }
  
  if (!y) return titleSlug;

  let yearSlug = y.toLowerCase()
    .replace(/[‚Äì‚Äî‚Äï‚àí]/g, "-")
    .replace(/^-/, "");
  
  const endsWithYear = new RegExp(`-${yearSlug.replace(/-/g, '\\-')}$`);
  return endsWithYear.test(titleSlug) ? titleSlug : `${titleSlug}-${yearSlug}`;
};

// –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
const checkYearRanges = () => {
  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –≥–æ–¥–æ–≤ –≤ URL —Å–æ–±—ã—Ç–∏–π...\n');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
  const eventsPath = path.join(__dirname, '../public/events-clean.json');
  const eventsData = JSON.parse(fs.readFileSync(eventsPath, 'utf-8'));
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –≥–æ–¥–æ–≤
  const eventsWithRanges = eventsData.filter(event => {
    const year = String(event.year || '');
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–µ—Ñ–∏—Å–∞ (–ª—é–±–æ–≥–æ —Ç–∏–ø–∞) –≤ –≥–æ–¥—É
    return /[‚Äì‚Äî‚Äï‚àí-]/.test(year) && !/bc|ad/i.test(year);
  });
  
  console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –≥–æ–¥–æ–≤: ${eventsWithRanges.length}`);
  console.log(`üìä –í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: ${eventsData.length}\n`);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ
  let correctCount = 0;
  let incorrectCount = 0;
  const incorrectEvents = [];
  
  eventsWithRanges.forEach((event, index) => {
    const slug = generateEventSlug(event.title, event.year);
    const url = `https://evid.world/event/${slug}`;
    const year = String(event.year);
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º year –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—Å–µ –¥–µ—Ñ–∏—Å—ã –∫ –æ–±—ã—á–Ω–æ–º—É)
    const normalizedYear = year.replace(/[‚Äì‚Äî‚Äï‚àí]/g, '-');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –≤ URL
    const hasRangeInUrl = slug.includes(normalizedYear);
    
    if (hasRangeInUrl) {
      correctCount++;
    } else {
      incorrectCount++;
      incorrectEvents.push({
        index: index + 1,
        title: event.title,
        year: event.year,
        slug: slug,
        url: url,
        normalizedYear: normalizedYear
      });
    }
  });
  
  // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:\n');
  console.log(`‚úì –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL: ${correctCount} (${Math.round(correctCount / eventsWithRanges.length * 100)}%)`);
  console.log(`‚úó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL: ${incorrectCount} (${Math.round(incorrectCount / eventsWithRanges.length * 100)}%)\n`);
  
  if (incorrectEvents.length > 0) {
    console.log('‚ùå –°–æ–±—ã—Ç–∏—è —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º –≤ URL:\n');
    incorrectEvents.forEach((event, idx) => {
      console.log(`${idx + 1}. "${event.title}"`);
      console.log(`   –ì–æ–¥: ${event.year}`);
      console.log(`   –û–∂–∏–¥–∞–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: ${event.normalizedYear}`);
      console.log(`   URL: ${event.url}`);
      console.log(`   Slug: ${event.slug}`);
      console.log('');
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª
    const reportPath = path.join(__dirname, 'year-ranges-report.json');
    fs.writeFileSync(reportPath, JSON.stringify(incorrectEvents, null, 2));
    console.log(`üìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${reportPath}\n`);
  } else {
    console.log('üéâ –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –≥–æ–¥–æ–≤ –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ URL!\n');
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL
  console.log('‚úì –ü—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL:\n');
  const correctExamples = eventsWithRanges
    .filter(e => {
      const slug = generateEventSlug(e.title, e.year);
      const normalizedYear = String(e.year).replace(/[‚Äì‚Äî‚Äï‚àí]/g, '-');
      return slug.includes(normalizedYear);
    })
    .slice(0, 5);
  
  correctExamples.forEach(event => {
    const slug = generateEventSlug(event.title, event.year);
    console.log(`  ‚Ä¢ ${event.title} (${event.year})`);
    console.log(`    https://evid.world/event/${slug}\n`);
  });
};

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
try {
  checkYearRanges();
} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
  process.exit(1);
}
